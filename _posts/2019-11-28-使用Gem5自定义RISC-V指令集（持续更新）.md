---
layout: post
title: 使用Gem5自定义RISC-V指令集
date: 2019-11-28
categories: 技术文章
tags: [随笔,技术文章]
description: 这是一个系列文章，重点介绍和记录个人在使用Gem5模拟器添加RISC-V自定义指令集的过程，希望能够为关注的人提供一些帮助和支持。
---

## 环境搭建
### Gem5 编译和示例运行
Gem5的编译，需要依赖一些库文件，在ubuntu上面可以执行下条命令完成安装：
```
sudo apt-get install git build-essential python-dev python scons zlib1g zlib1g-dev m4 libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev
```
当所有这些库文件安装好以后，就可以克隆gem5的仓库了，有两个链接：
```
git clone https://gem5.googlesource.com/public/gem5
https://github.com/gem5/gem5(会以每15分钟的频率同步上面的链接)
```
接下来就可以使用scons工具编译Gem5模拟器了，里面有不同的ISA模型，选择RISC-V就行，在编译的时候，可以根据需要选择不同的类型和CPU模型，具体可以查看Gem5的帮助文档：
```
scons build/riscv/gem5.opt -j4
```
第一次编译，会花费比较长的时间，后续的编译都是增量编译。
如果编译过程没有什么问题，你就会得到一个模拟器的可执行文件：gem5.opt。为了验证正确与否，可以执行以下预先编译好的hello world程序。
```
./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello/bin/riscv/linux/hello --output=sim.out --errout=sim.err
```
执行的log如下所示：
```
gem5 Simulator System.  http://gem5.org
gem5 is copyrighted software; use the --copyright option for details.

gem5 compiled Nov 25 2019 17:19:20
gem5 started Nov 28 2019 14:07:22
gem5 executing on llvm-vm, pid 61827
command line: ./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello/bin/riscv/linux/hello --output=sim.out --errout=sim.err

Global frequency set at 1000000000000 ticks per second
warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (512 Mbytes)
0: system.remote_gdb: listening for remote gdb on port 7000
**** REAL SIMULATION ****
info: Entering event queue @ 0.  Starting simulation...
info: Increasing stack size by one page.
Exiting @ tick 2988000 because exiting with last active thread context
llvm@llvm-vm:~/workspace/gem5$ cat m5out/sim.out 
Hello world!
```

至此，一个可以耍起来的Gem5环境已经搭建完毕。

### RISC-V编译环境搭建

