---
layout: post
title: 使用Gem5自定义RISC-V指令集
date: 2019-11-28
categories: 技术文章
tags: [随笔,技术文章]
description: 这是一个系列文章，重点介绍和记录个人在使用Gem5模拟器添加RISC-V自定义指令集的过程，希望能够为关注的人提供一些帮助和支持。
---

## 环境搭建
### Gem5 编译和示例运行
Gem5的编译，需要依赖一些库文件，在ubuntu上面可以执行下条命令完成安装：
```
sudo apt-get install git build-essential python-dev python scons zlib1g zlib1g-dev m4 libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev
```
当所有这些库文件安装好以后，就可以克隆gem5的仓库了，有两个链接：
```
git clone https://gem5.googlesource.com/public/gem5
https://github.com/gem5/gem5(会以每15分钟的频率同步上面的链接)
```
接下来就可以使用scons工具编译Gem5模拟器了，里面有不同的ISA模型，选择RISC-V就行，在编译的时候，可以根据需要选择不同的类型和CPU模型，具体可以查看Gem5的帮助文档：
```
scons build/riscv/gem5.opt -j4
```
第一次编译，会花费比较长的时间，后续的编译都是增量编译。
如果编译过程没有什么问题，你就会得到一个模拟器的可执行文件：gem5.opt。为了验证正确与否，可以执行以下预先编译好的hello world程序。
```
./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello/bin/riscv/linux/hello --output=sim.out --errout=sim.err
```
执行的log如下所示：
```
gem5 Simulator System.  http://gem5.org
gem5 is copyrighted software; use the --copyright option for details.

gem5 compiled Nov 25 2019 17:19:20
gem5 started Nov 28 2019 14:07:22
gem5 executing on llvm-vm, pid 61827
command line: ./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello/bin/riscv/linux/hello --output=sim.out --errout=sim.err

Global frequency set at 1000000000000 ticks per second
warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (512 Mbytes)
0: system.remote_gdb: listening for remote gdb on port 7000
**** REAL SIMULATION ****
info: Entering event queue @ 0.  Starting simulation...
info: Increasing stack size by one page.
Exiting @ tick 2988000 because exiting with last active thread context
llvm@llvm-vm:~/workspace/gem5$ cat m5out/sim.out 
Hello world!
```

至此，一个可以耍起来的Gem5环境已经搭建完毕。

### RISC-V编译环境搭建

想要让Gem5模拟器执行RISC-V的程序代码，就还需要一个交叉编译环境（Cross Compiler），注意这里需要的是Linux的交叉工具链（riscv64-unknown-linux-gnu），而不是ELF的(riscv64-unknown-elf)。

当然，最直接的方式就是下载riscv官方仓库的代码进行编译，然而，无奈博主所在单位的网络不行，下载一直持续性中断，其他人可以尝试一下。
```
git clone https://github.com/riscv/riscv-gnu-toolchain
cd riscv-gnu-toolchain
git submodule update --init --recursive
```
博主尝试找了两个提供Linux交叉工具链的网站，但是都不凑效，一家是Arch Linux，另外一家是平头哥，感兴趣的可以下载来尝试尝试。平头哥家的工具链，添加了一些自己的指令，比如addsl，gem5的编译器不支持。
```
1. https://www.archlinux.org/packages/community/x86_64/riscv64-linux-gnu-gcc/
2. https://www.t-head.cn/file/download?spm=a2ouz.12987056.0.0.356648abVoxMr2&file=1571624106073/T-Head%20Tools%20package.zip
```
无奈之下，博主下载了CNRV（感谢群头，感谢SiFive），尽管最后的更新停留在2018.7.11日，但是下载好后，编译都正常，最重要的是可以运行。
```
https://pan.baidu.com/s/1J9N2VvfY9D6zakh8aMO5rg
GitHash: 397c395
MD5Sum: 63b711236a118df48d035b65b1fa5065
打包时间: 2018-Jun-11
```
解压编译安装后，你就会获得下列工具：

```
./configure --prefix=/opt/riscv
make

or

./configure --prefix=/opt/riscv
make linux

or

./configure --prefix=/opt/riscv --enable-multilib
make linux
```

```
llvm@llvm-vm:~/workspace/freedom/rocket-chip/riscv-tools/riscv-tc/bin$ ls
elf2hex                              riscv64-unknown-linux-gnu-as
openocd                              riscv64-unknown-linux-gnu-c++
riscv64-unknown-elf-addr2line        riscv64-unknown-linux-gnu-c++filt
riscv64-unknown-elf-ar               riscv64-unknown-linux-gnu-cpp
riscv64-unknown-elf-as               riscv64-unknown-linux-gnu-elfedit
riscv64-unknown-elf-c++              riscv64-unknown-linux-gnu-g++
riscv64-unknown-elf-c++filt          riscv64-unknown-linux-gnu-gcc
riscv64-unknown-elf-cpp              riscv64-unknown-linux-gnu-gcc-7.2.0
riscv64-unknown-elf-elfedit          riscv64-unknown-linux-gnu-gcc-ar
riscv64-unknown-elf-g++              riscv64-unknown-linux-gnu-gcc-nm
riscv64-unknown-elf-gcc              riscv64-unknown-linux-gnu-gcc-ranlib
riscv64-unknown-elf-gcc-7.2.0        riscv64-unknown-linux-gnu-gcov
riscv64-unknown-elf-gcc-ar           riscv64-unknown-linux-gnu-gcov-dump
riscv64-unknown-elf-gcc-nm           riscv64-unknown-linux-gnu-gcov-tool
riscv64-unknown-elf-gcc-ranlib       riscv64-unknown-linux-gnu-gdb
riscv64-unknown-elf-gcov             riscv64-unknown-linux-gnu-gfortran
riscv64-unknown-elf-gcov-dump        riscv64-unknown-linux-gnu-gprof
riscv64-unknown-elf-gcov-tool        riscv64-unknown-linux-gnu-ld
riscv64-unknown-elf-gdb              riscv64-unknown-linux-gnu-ld.bfd
riscv64-unknown-elf-gprof            riscv64-unknown-linux-gnu-nm
riscv64-unknown-elf-ld               riscv64-unknown-linux-gnu-objcopy
riscv64-unknown-elf-ld.bfd           riscv64-unknown-linux-gnu-objdump
riscv64-unknown-elf-nm               riscv64-unknown-linux-gnu-ranlib
riscv64-unknown-elf-objcopy          riscv64-unknown-linux-gnu-readelf
riscv64-unknown-elf-objdump          riscv64-unknown-linux-gnu-run
riscv64-unknown-elf-ranlib           riscv64-unknown-linux-gnu-size
riscv64-unknown-elf-readelf          riscv64-unknown-linux-gnu-strings
riscv64-unknown-elf-run              riscv64-unknown-linux-gnu-strip
riscv64-unknown-elf-size             spike
riscv64-unknown-elf-strings          spike-dasm
riscv64-unknown-elf-strip            termios-xspike
riscv64-unknown-linux-gnu-addr2line  xspike
riscv64-unknown-linux-gnu-ar
```
编写一个简单的hello world程序，例如
```
#include <stdio.h>

int main(int argc, char* argv[])
{
    printf("Hello Haawking!\n");
    return 0;
}
```

编译程序：
```
../../../../freedom/rocket-chip/riscv-tools/riscv-tc/bin/riscv64-unknown-linux-gnu-gcc -static -v -o hello hello.c
```

执行的log如下所示：
```
llvm@llvm-vm:~/workspace/gem5$ ./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello_haawking/hello --output=sim.out --errout=sim.err
gem5 Simulator System.  http://gem5.org
gem5 is copyrighted software; use the --copyright option for details.

gem5 compiled Nov 25 2019 17:19:20
gem5 started Nov 28 2019 11:46:28
gem5 executing on llvm-vm, pid 61610
command line: ./build/RISCV/gem5.opt configs/example/se.py -c tests/test-progs/hello_haawking/hello --output=sim.out --errout=sim.err

Global frequency set at 1000000000000 ticks per second
warn: DRAM device capacity (8192 Mbytes) does not match the address range assigned (512 Mbytes)
0: system.remote_gdb: listening for remote gdb on port 7000
**** REAL SIMULATION ****
info: Entering event queue @ 0.  Starting simulation...
info: Increasing stack size by one page.
Exiting @ tick 3370000 because exiting with last active thread context   
llvm@llvm-vm:~/workspace/gem5$ cat m5out/sim.out 
Hello Haawking!
```

## 工具链新增指令
在工具链的不同层级加入一条或多条指令，其工作量和编程友好度是不同的，最直接也是最低层次的一种方法是**添加机器码**，这种方法最为直接，但是也是效率最低的一种方式，特别是当指令数量增加的时候，程序员需要记得一串二进制数字代表的指令含义。这种方法适用于添加一两条指令的初期探索阶段。

```
.word 0x34567bd0
```

另外一种更高层次的添加指令的方式是通过修改Binutlis的insn，这种层次的修改，相对于机器码来说，更高效一些。例如，一条add指令，其insn格式为
```
add a0,a1,a2  <------->   .insn r 0x33,0,0,a0,a1,a2
```
The RISC-V Instruction Set Manual Volume I: User-Level ISA lists 12 instruction formats where some of the formats have multiple variants. For the ‘.insn’ pseudo directive the assembler recognizes some of the formats. Typically, the most general variant of the instruction format is used by the ‘.insn’ directive.
[RISC-V Instruction Formats](https://embarc.org/man-pages/as/RISC_002dV_002dFormats.html#RISC_002dV_002dFormats)
```
R type: .insn r opcode, func3, func7, rd, rs1, rs2
     +-------+-----+-----+-------+----+-------------+
     | func7 | rs2 | rs1 | func3 | rd |      opcode |
     +-------+-----+-----+-------+----+-------------+
     31      25    20    15      12   7             0

R type with 4 register operands: .insn r opcode, func3, func2, rd, rs1, rs2, rs3
     +-----+-------+-----+-----+-------+----+-------------+
     | rs3 | func2 | rs2 | rs1 | func3 | rd |      opcode |
     +-----+-------+-----+-----+-------+----+-------------+
     31    27      25    20    15      12   7             0

I type: .insn i opcode, func3, rd, rs1, simm12
     +-------------+-----+-------+----+-------------+
     |      simm12 | rs1 | func3 | rd |      opcode |
     +-------------+-----+-------+----+-------------+
     31            20    15      12   7             0

S type: .insn s opcode, func3, rd, rs1, simm12
     +--------------+-----+-----+-------+-------------+-------------+
     | simm12[11:5] | rs2 | rs1 | func3 | simm12[4:0] |      opcode |
     +--------------+-----+-----+-------+-------------+-------------+
     31             25    20    15      12            7             0

SB type: .insn sb opcode, func3, rd, rs1, symbol
SB type: .insn sb opcode, func3, rd, simm12(rs1)
     +--------------+-----+-----+-------+-------------+-------------+
     | simm21[11:5] | rs2 | rs1 | func3 | simm12[4:0] |      opcode |
     +--------------+-----+-----+-------+-------------+-------------+
     31             25    20    15      12            7             0

U type: .insn u opcode, rd, simm20
     +---------------------------+----+-------------+
     |                    simm20 | rd |      opcode |
     +---------------------------+----+-------------+
     31                          12   7             0

UJ type: .insn uj opcode, rd, symbol
     +------------+--------------+------------+---------------+----+-------------+
     | simm20[20] | simm20[10:1] | simm20[11] | simm20[19:12] | rd |      opcode |
     +------------+--------------+------------+---------------+----+-------------+
     31           30             21           20              12   7             0

CR type: .insn cr opcode2, func4, rd, rs2
     +---------+--------+-----+---------+
     |   func4 | rd/rs1 | rs2 | opcode2 |
     +---------+--------+-----+---------+
     15        12       7     2        0

CI type: .insn ci opcode2, func3, rd, simm6
     +---------+-----+--------+-----+---------+
     |   func3 | imm | rd/rs1 | imm | opcode2 |
     +---------+-----+--------+-----+---------+
     15        13    12       7     2         0

CIW type: .insn ciw opcode2, func3, rd, uimm8
     +---------+--------------+-----+---------+
     |   func3 |          imm | rd' | opcode2 |
     +---------+--------------+-----+---------+
     15        13             7     2         0

CA type: .insn ca opcode2, func6, func2, rd, rs2
     +---------+----------+-------+------+--------+
     |   func6 | rd'/rs1' | func2 | rs2' | opcode |
     +---------+----------+-------+------+--------+
     15        10         7       5      2        0

CB type: .insn cb opcode2, func3, rs1, symbol
     +---------+--------+------+--------+---------+
     |   func3 | offset | rs1' | offset | opcode2 |
     +---------+--------+------+--------+---------+
     15        13       10     7        2         0

CJ type: .insn cj opcode2, symbol
     +---------+--------------------+---------+
     |   func3 |        jump target | opcode2 |
     +---------+--------------------+---------+
     15        13             7     2         0
	 
```
第三种方式，相较于第二种，编程更为友好一些。需要借助于riscv-opcodes工具以及riscv-binutils-gdb工具的修改。这种方法，程序员可以在c程序中内嵌汇编或者直接编写汇编程序，反汇编之后也可以看到相应的指令，例如，当增加一条mod指令后，就可以这样编程：
```
  asm volatile
  (
    "mod   %[z], %[x], %[y]\n\t"
    : [z] "=r" (c)
    : [x] "r" (a), [y] "r" (b)
  ) ; 
```
第四种方法，就是需要修改编译器，使得用户可以直接编写C等高级语言的应用程序。

### 修改编译器

如果编译器没有修改，直接编译上面的程序代码，就会报类似的错误：
```
llvm@llvm-vm:~/workspace/gem5/tests/test-progs/mod_test$ ../../../../freedom/rocket-chip/riscv-tools/riscv-tc/bin/riscv64-unknown-linux-gnu-gcc --static -o mod_test mod_test.c 
mod_test.c: Assembler messages:
mod_test.c:38: Error: unrecognized opcode `mod a5,a5,a4'
```
这部分主要参考NITISH SRIVASTAVA
的这篇教程，感兴趣的可以看原文，我这里只是进行一些修改记录。[Adding custom instruction to RISCV ISA and running it on gem5 and spike](https://nitish2112.github.io/post/adding-instruction-riscv/)
首先在riscv-tools/riscv-opcodes/opcodes文件中添加下列代码，这里只是教程的示例，后面可能需要根据自己的设计，修改编码内容和赋值。
```
mod     rd rs1 rs2 31..25=1  14..12=0 6..2=0x1A 1..0=3
```
然后在当前目录下运行下列代码，获取MATCH和MASK。
```
cat opcodes-pseudo opcodes opcodes-rvc opcodes-rvc-pseudo opcodes-custom | ./parse-opcodes -c > ~/temp.h
```
```
#define MATCH_MOD 0x200006b                                                    
#define MASK_MOD 0xfe00707f
```
之后就是修改riscv-gnu-toolchain/riscv-binutils-gdb/include/opcode/riscv-opc.h和riscv-gnu-toolchain/riscv-binutils-gdb/opcodes/riscv-opc.c，分别修改头文件和源文件。在头文件里添加MATCH和MASK，在源文件里，添加如下代码：
```
const struct riscv_opcode riscv_opcodes[] =                                     
{                                                                               
/* name,      isa,   operands, match, mask, match_func, pinfo.  */              
....
....
....
{"mod",       "I",   "d,s,t",  MATCH_MOD, MASK_MOD, match_opcode, 0 }
....
....
```
接下来就重新编译一下工具链riscv-gnu-toolchain，不出问题，应该就可以识别开头的那段程序了。
输出结果为：
```
llvm@llvm-vm:~/workspace/gem5/tests/test-progs/mod_test$ ../../../../freedom/rocket-chip/riscv-tools/riscv-tc-new/bin/riscv64-unknown-linux-gnu-gcc  --static -o mod_test mod_test.c
llvm@llvm-vm:~/workspace/gem5/tests/test-progs/mod_test$ ../../../../freedom/rocket-chip/riscv-tools/riscv-tc-new/bin/riscv64-unknown-linux-gnu-objdump -D mod_test | grep "mod"
mod_test:     file format elf64-littleriscv
   102ca:	02e787eb          	mod	a5,a5,a4
   1594e:	070030ef          	jal	ra,189be <_IO_switch_to_get_mode>
   15c16:	3cf230ef          	jal	ra,397e4 <_IO_switch_to_wget_mode>
   15cd4:	311230ef          	jal	ra,397e4 <_IO_switch_to_wget_mode>
   16c98:	527010ef          	jal	ra,189be <_IO_switch_to_get_mode>
   17068:	157010ef          	jal	ra,189be <_IO_switch_to_get_mode>
```


### 修改Gem5模拟器
